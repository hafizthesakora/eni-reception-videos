<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Upload - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .bg-eni-yellow {
        background-color: #ffc72c;
      }
      .bg-eni-yellow:hover {
        background-color: #fabe00;
      }
      .spinner {
        border-top-color: #fabe00;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <header class="bg-white shadow-md">
      <nav
        class="container mx-auto px-6 py-4 flex justify-between items-center"
      >
        <div class="flex items-center space-x-4">
          <img
            src="eni_logo.png"
            alt="Eni Ghana Logo"
            class="h-10 w-auto"
            onerror="this.onerror=null;this.src='https://placehold.co/150x50/ffffff/000000?text=Eni+Logo';"
          />
          <span class="text-xl font-semibold text-gray-900">Eni Ghana</span>
        </div>
        <a href="index.html" class="text-sm text-yellow-600 hover:underline"
          >← Back to Home</a
        >
      </nav>
    </header>

    <div class="container mx-auto px-6 py-12">
      <div class="stats grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div
          class="stat-card bg-white p-6 rounded-lg shadow-sm border border-gray-200"
        >
          <div
            class="stat-number text-3xl font-bold text-yellow-600"
            id="videoCount"
          >
            0
          </div>
          <div class="stat-label text-gray-500">Videos in Playlist</div>
        </div>
        <div
          class="stat-card bg-white p-6 rounded-lg shadow-sm border border-gray-200"
        >
          <div
            class="stat-number text-3xl font-bold text-yellow-600"
            id="totalSize"
          >
            0 MB
          </div>
          <div class="stat-label text-gray-500">Total Size in Playlist</div>
        </div>
      </div>

      <div id="upload-container">
        <div
          class="upload-section bg-white border-2 border-dashed border-gray-300 rounded-lg p-12 text-center transition-all duration-300"
          onclick="document.getElementById('fileInput').click()"
        >
          <div class="upload-icon mx-auto h-16 w-16 text-gray-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
              />
            </svg>
          </div>
          <p class="upload-text mt-4 text-lg font-semibold text-gray-700">
            Click here or drag videos to upload
          </p>
          <p class="text-sm text-gray-500 mt-1">
            Videos will be uploaded to Cloudinary
          </p>
          <input
            type="file"
            id="fileInput"
            class="hidden"
            multiple
            accept="video/*"
          />
        </div>
      </div>

      <div id="status-area" class="text-center mt-4 text-gray-600 h-6"></div>

      <div class="video-list mt-10">
        <h2 class="text-2xl font-bold mb-4 flex items-center">
          Uploaded Videos
          <div
            id="loading-spinner"
            class="hidden spinner ml-4 h-6 w-6 rounded-full border-4 border-gray-200"
          ></div>
        </h2>
        <div
          id="videoListContainer"
          class="bg-white rounded-lg shadow-sm border border-gray-200"
        ></div>
      </div>
    </div>

    <script>
      // --- STEP 1: PASTE YOUR CLOUDINARY CONFIGS ---
      const CLOUDINARY_CLOUD_NAME = 'YOUR_CLOUD_NAME';
      const CLOUDINARY_UPLOAD_PRESET = 'YOUR_UPLOAD_PRESET';
      // ---------------------------------------------

      // This is the unique name for our playlist file in Cloudinary.
      const PLAYLIST_PUBLIC_ID = 'eni_video_playlist';

      // UI Elements & State
      const fileInput = document.getElementById('fileInput');
      const uploadSection = document.querySelector('.upload-section');
      const videoListContainer = document.getElementById('videoListContainer');
      const statusArea = document.getElementById('status-area');
      const loadingSpinner = document.getElementById('loading-spinner');
      let currentPlaylist = [];

      // --- CORE FUNCTIONS ---

      async function getPlaylist() {
        loadingSpinner.classList.remove('hidden');
        const cacheBuster = `?_=${new Date().getTime()}`;
        const url = `https://res.cloudinary.com/${CLOUDINARY_CLOUD_NAME}/raw/upload/${PLAYLIST_PUBLIC_ID}.json${cacheBuster}`;
        try {
          const response = await fetch(url);
          if (!response.ok) {
            if (response.status === 404) return []; // File doesn't exist yet, return empty list
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return await response.json();
        } catch (error) {
          console.error('Could not fetch playlist:', error);
          return []; // Return empty list on error
        } finally {
          loadingSpinner.classList.add('hidden');
        }
      }

      async function savePlaylist(playlist) {
        statusArea.textContent = 'Saving updated playlist...';
        loadingSpinner.classList.remove('hidden');
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/raw/upload`;
        const jsonString = JSON.stringify(playlist, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const file = new File([blob], `${PLAYLIST_PUBLIC_ID}.json`);

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('public_id', PLAYLIST_PUBLIC_ID);

        try {
          const response = await fetch(url, { method: 'POST', body: formData });
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          statusArea.textContent = 'Playlist saved successfully!';
        } catch (error) {
          console.error('Could not save playlist:', error);
          statusArea.textContent = 'Error saving playlist.';
        } finally {
          loadingSpinner.classList.add('hidden');
          setTimeout(() => (statusArea.textContent = ''), 3000);
        }
      }

      async function uploadVideoFile(file) {
        statusArea.textContent = `Uploading ${file.name}...`;
        loadingSpinner.classList.remove('hidden');
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/video/upload`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

        try {
          const response = await fetch(url, { method: 'POST', body: formData });
          const data = await response.json();
          if (data.error) throw new Error(data.error.message);
          return data;
        } catch (error) {
          console.error(`Upload failed for ${file.name}:`, error);
          statusArea.textContent = `Error uploading ${file.name}.`;
          return null;
        } finally {
          loadingSpinner.classList.add('hidden');
          setTimeout(() => (statusArea.textContent = ''), 3000);
        }
      }

      async function loadAndRender() {
        currentPlaylist = await getPlaylist();
        renderVideos();
        updateStats();
      }

      // --- EVENT HANDLERS ---
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
      uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('bg-yellow-50', 'border-yellow-400');
      });
      uploadSection.addEventListener('dragleave', () =>
        uploadSection.classList.remove('bg-yellow-50', 'border-yellow-400')
      );
      uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('bg-yellow-50', 'border-yellow-400');
        handleFiles(e.dataTransfer.files);
      });

      async function handleFiles(files) {
        const videoFiles = Array.from(files).filter((file) =>
          file.type.startsWith('video/')
        );
        if (videoFiles.length === 0) return;

        for (const file of videoFiles) {
          const videoData = await uploadVideoFile(file);
          if (videoData) {
            currentPlaylist.push({
              id: videoData.public_id,
              name: videoData.original_filename || file.name,
              url: videoData.secure_url,
              size: videoData.bytes,
              createdAt: new Date().toISOString(),
            });
          }
        }
        // Save the entire updated playlist once after all uploads are done
        await savePlaylist(currentPlaylist);
        // Re-render the list from the newly saved playlist
        await loadAndRender();
      }

      videoListContainer.addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
          const videoId = deleteBtn.dataset.id;
          if (
            confirm(
              'Are you sure you want to remove this video from the playlist?'
            )
          ) {
            currentPlaylist = currentPlaylist.filter(
              (video) => video.id !== videoId
            );
            await savePlaylist(currentPlaylist);
            await loadAndRender();
          }
        }
      });

      // --- UI RENDERING ---
      function renderVideos() {
        if (currentPlaylist.length === 0) {
          videoListContainer.innerHTML = `<p class="text-center text-gray-500 py-10">No videos uploaded yet.</p>`;
          return;
        }
        videoListContainer.innerHTML = [...currentPlaylist]
          .reverse()
          .map(
            (video) => `
                <div class="flex items-center justify-between p-4 border-b border-gray-200 last:border-b-0">
                    <div><p class="font-semibold">${
                      video.name
                    }</p><p class="text-sm text-gray-500">${formatFileSize(
              video.size
            )} • Uploaded: ${new Date(
              video.createdAt
            ).toLocaleString()}</p></div>
                    <button class="delete-btn text-gray-400 hover:text-red-600 transition-colors" data-id="${
                      video.id
                    }"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>`
          )
          .join('');
      }

      function updateStats() {
        document.getElementById('videoCount').textContent =
          currentPlaylist.length;
        const totalBytes = currentPlaylist.reduce(
          (sum, video) => sum + (video.size || 0),
          0
        );
        document.getElementById('totalSize').textContent =
          formatFileSize(totalBytes);
      }

      function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
          ' ' +
          ['Bytes', 'KB', 'MB', 'GB', 'TB'][i]
        );
      }

      // Initial Load
      loadAndRender();
    </script>
  </body>
</html>
