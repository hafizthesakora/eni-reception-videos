<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Upload - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .bg-eni-yellow {
        background-color: #ffc72c;
      }
      .bg-eni-yellow:hover {
        background-color: #fabe00;
      }
      .loader {
        border-top-color: #fabe00;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <header class="bg-white shadow-md">
      <nav
        class="container mx-auto px-6 py-4 flex justify-between items-center"
      >
        <div class="flex items-center space-x-4">
          <img
            src="eni_logo.png"
            alt="Eni Ghana Logo"
            class="h-10 w-auto"
            onerror="this.onerror=null;this.src='https://placehold.co/150x50/ffffff/000000?text=Eni+Logo';"
          />
          <span class="text-xl font-semibold text-gray-900">Eni Ghana</span>
        </div>
        <a href="index.html" class="text-sm text-yellow-600 hover:underline"
          >← Back to Home</a
        >
      </nav>
    </header>

    <div class="container mx-auto px-6 py-12">
      <div class="stats grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div
          class="stat-card bg-white p-6 rounded-lg shadow-sm border border-gray-200"
        >
          <div
            class="stat-number text-3xl font-bold text-yellow-600"
            id="videoCount"
          >
            0
          </div>
          <div class="stat-label text-gray-500">Videos Uploaded</div>
        </div>
        <div
          class="stat-card bg-white p-6 rounded-lg shadow-sm border border-gray-200"
        >
          <div
            class="stat-number text-3xl font-bold text-yellow-600"
            id="totalSize"
          >
            0 MB
          </div>
          <div class="stat-label text-gray-500">Total Storage Used</div>
        </div>
      </div>

      <div id="upload-container">
        <div
          class="upload-section bg-white border-2 border-dashed border-gray-300 rounded-lg p-12 text-center transition-all duration-300"
          onclick="document.getElementById('fileInput').click()"
        >
          <div class="upload-icon mx-auto h-16 w-16 text-gray-400">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"
              />
            </svg>
          </div>
          <p class="upload-text mt-4 text-lg font-semibold text-gray-700">
            Click here or drag videos to upload
          </p>
          <p class="text-sm text-gray-500 mt-1">
            Supported formats: MP4, WebM, MOV
          </p>
          <input
            type="file"
            id="fileInput"
            class="hidden"
            multiple
            accept="video/mp4,video/webm,video/quicktime"
          />
        </div>
      </div>

      <div id="upload-progress-container" class="hidden mt-6"></div>

      <div class="video-list mt-10">
        <h2 class="text-2xl font-bold mb-4">Uploaded Videos</h2>
        <div
          id="videoListContainer"
          class="bg-white rounded-lg shadow-sm border border-gray-200"
        ></div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
      import {
        getAuth,
        signInAnonymously,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        deleteDoc,
        onSnapshot,
        serverTimestamp,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
      import {
        getStorage,
        ref,
        uploadBytesResumable,
        getDownloadURL,
        deleteObject,
      } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';

      // --- STEP 1: PASTE YOUR FIREBASE CONFIG HERE ---
      // You get this from your project settings on the Firebase website.
      const firebaseConfig = {
        apiKey: 'AIzaSyBc9HvS4ihm9UnI9Rk65SnrDB5rDMIf4WI',
        authDomain: 'eni-display-system.firebaseapp.com',
        projectId: 'eni-display-system',
        storageBucket: 'eni-display-system.firebasestorage.app',
        messagingSenderId: '62167080833',
        appId: '1:62167080833:web:e6e4956b8a184ec25c9280',
        measurementId: 'G-QHXJ85VP0D',
      };
      // ---------------------------------------------

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      const videosCollectionRef = collection(db, 'videos');

      // UI Elements, State, and Functions
      let videos = [];
      const fileInput = document.getElementById('fileInput');
      const uploadSection = document.querySelector('.upload-section');
      const progressContainer = document.getElementById(
        'upload-progress-container'
      );

      signInAnonymously(auth).catch((error) =>
        console.error('Anonymous sign-in failed:', error)
      );

      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
      uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('bg-yellow-50', 'border-yellow-400');
      });
      uploadSection.addEventListener('dragleave', () =>
        uploadSection.classList.remove('bg-yellow-50', 'border-yellow-400')
      );
      uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('bg-yellow-50', 'border-yellow-400');
        handleFiles(e.dataTransfer.files);
      });

      function handleFiles(files) {
        const videoFiles = Array.from(files).filter((file) =>
          file.type.startsWith('video/')
        );
        if (videoFiles.length === 0) return;
        progressContainer.innerHTML = '';
        progressContainer.classList.remove('hidden');
        videoFiles.forEach(uploadFile);
      }

      function uploadFile(file) {
        const fileId = `file-${Date.now()}-${Math.random()
          .toString(36)
          .substring(2)}`;
        const storageRef = ref(storage, `videos/${Date.now()}-${file.name}`);
        const uploadTask = uploadBytesResumable(storageRef, file);
        const progressElement = document.createElement('div');
        progressElement.id = fileId;
        progressElement.className =
          'bg-white p-4 rounded-lg shadow-sm border mb-3';
        progressElement.innerHTML = `
                <div class="flex justify-between items-center"><p class="text-sm font-medium truncate w-2/3">${file.name}</p><p class="text-sm text-gray-500" id="${fileId}-status">Uploading...</p></div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div id="${fileId}-bar" class="bg-yellow-400 h-2.5 rounded-full" style="width: 0%"></div></div>`;
        progressContainer.appendChild(progressElement);
        uploadTask.on(
          'state_changed',
          (snapshot) => {
            const progress =
              (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById(`${fileId}-bar`).style.width =
              progress + '%';
          },
          (error) => {
            console.error('Upload failed:', error);
            document.getElementById(`${fileId}-status`).textContent = 'Error!';
            document
              .getElementById(`${fileId}-bar`)
              .classList.add('bg-red-500');
          },
          () => {
            getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
              addDoc(videosCollectionRef, {
                name: file.name,
                url: downloadURL,
                storagePath: uploadTask.snapshot.ref.fullPath,
                size: file.size,
                type: file.type,
                createdAt: serverTimestamp(),
              }).then(() => {
                document.getElementById(`${fileId}-status`).textContent =
                  'Complete!';
                document
                  .getElementById(`${fileId}-bar`)
                  .classList.add('bg-green-500');
              });
            });
          }
        );
      }

      onSnapshot(videosCollectionRef, (snapshot) => {
        videos = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        videos.sort(
          (a, b) =>
            (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)
        );
        renderVideos();
        updateStats();
      });

      function renderVideos() {
        const listContainer = document.getElementById('videoListContainer');
        if (videos.length === 0) {
          listContainer.innerHTML = `<p class="text-center text-gray-500 py-10">No videos uploaded yet.</p>`;
          return;
        }
        listContainer.innerHTML = videos
          .map(
            (video) => `
                <div class="flex items-center justify-between p-4 border-b border-gray-200 last:border-b-0">
                    <div><p class="font-semibold">${
                      video.name
                    }</p><p class="text-sm text-gray-500">${formatFileSize(
              video.size
            )} • Uploaded: ${
              video.createdAt
                ? new Date(video.createdAt.toDate()).toLocaleString()
                : 'Just now'
            }</p></div>
                    <button class="delete-btn text-gray-400 hover:text-red-600 transition-colors" data-id="${
                      video.id
                    }" data-path="${
              video.storagePath
            }"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>`
          )
          .join('');
      }

      document
        .getElementById('videoListContainer')
        .addEventListener('click', (e) => {
          const deleteBtn = e.target.closest('.delete-btn');
          if (deleteBtn) {
            const videoId = deleteBtn.dataset.id;
            const storagePath = deleteBtn.dataset.path;
            if (
              confirm('Are you sure you want to permanently delete this video?')
            ) {
              deleteVideo(videoId, storagePath);
            }
          }
        });

      async function deleteVideo(id, storagePath) {
        try {
          await deleteDoc(doc(db, 'videos', id));
          const storageRef = ref(storage, storagePath);
          await deleteObject(storageRef);
        } catch (error) {
          console.error('Error deleting video:', error);
          alert('Failed to delete video.');
        }
      }

      function updateStats() {
        document.getElementById('videoCount').textContent = videos.length;
        const totalBytes = videos.reduce(
          (sum, video) => sum + (video.size || 0),
          0
        );
        document.getElementById('totalSize').textContent =
          formatFileSize(totalBytes);
      }

      function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
          ' ' +
          ['Bytes', 'KB', 'MB', 'GB', 'TB'][i]
        );
      }
    </script>
  </body>
</html>
